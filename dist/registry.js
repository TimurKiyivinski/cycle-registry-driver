'use strict';Object.defineProperty(exports,'__esModule',{value:!0});function Registry(c){var d=this;this.url=c,this.callbacks={},this.fetchImageTags=function(f){return fetch(d.url+'/v2/'+f+'/tags/list')},this.fetchImageManifest=function(f,g){var j={method:'GET',headers:new Headers({Accept:'application/vnd.docker.distribution.manifest.v2+json'})};return fetch(d.url+'/v2/'+f+'/manifests/'+g,j)},this.fetchImageManifests=function(f){return new Promise(function(g,h){d.fetchImageTags(f).then(function(j){return j.json()}).then(function(j){var k=j.tags.map(function(l){return{name:j.name,tag:l,promise:d.fetchImageManifest(j.name,l)}});Promise.all(k.map(function(l){return l.promise})).then(function(l){Promise.all(l.map(function(m){return m.json()})).then(function(m){var n=m.map(function(o,p){return Object.assign({name:k[p].name,tag:k[p].tag},o)});g(n)}).catch(function(m){return h(m)})}).catch(function(l){return h(l)})})})},this.getCatalog=function(f){fetch(d.url+'/v2/_catalog').then(function(g){return g.json()}).then(f)},this.getCatalogWithTags=function(f){d.getCatalog(function(g){var h=g.repositories.map(function(j){return d.fetchImageTags(j)});Promise.all(h).then(function(j){return j.map(function(k){return k.json()})}).then(function(j){return Promise.all(j).then(function(k){return f({repositories:k})})})})},this.getCatalogWithManifests=function(f){d.getCatalog(function(g){var h=g.repositories.map(function(j){return d.fetchImageManifests(j)});Promise.all(h).then(function(j){return Promise.all(j).then(function(k){return f({repositories:k.reduce(function(l,m){return l.concat(m)})})})})})},this.call=function(f,g){if('catalog'===g)d.getCatalog(d.callbacks[f]);else if('catalog::tags'===g)d.getCatalogWithTags(d.callbacks[f]);else if('catalog::manifests'===g)d.getCatalogWithManifests(d.callbacks[f]);else{var h=g.split('::');if(2!==h.length)throw new Error('Invalid registry driver request');var j=h[0],k=h[1];if('tags'===k)d.fetchImageTags(j).then(function(l){return l.json()}).then(function(l){d.callbacks[f](l)});else if('manifest'===k){var l=j.split(':');if(2!==l.length)throw new Error('No image tag specified');j=l[0];var m=l[1];d.fetchImageManifest(j,m).then(function(n){return n.json()}).then(function(n){d.callbacks[f](n)})}else throw new Error('Invalid repository action '+k)}},this.onReceive=function(f,g){d.callbacks[f]=g}}exports.default=Registry;